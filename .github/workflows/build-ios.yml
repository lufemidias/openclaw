name: Build OpenClaw iOS

on:
  workflow_dispatch:
    inputs:
      signing_mode:
        description: 'Signing mode'
        required: true
        default: 'personal'
        type: choice
        options:
          - personal
          - developer

jobs:
  build:
    runs-on: macos-15
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        run: npm install -g pnpm@latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile || pnpm install

      - name: Install xcodegen
        run: brew install xcodegen

      - name: List available Xcode versions
        run: |
          ls -d /Applications/Xcode*.app 2>/dev/null || true
          
      - name: Select Xcode (need Swift 6.2+)
        run: |
          # Pick the latest Xcode available (sort by version number)
          LATEST=$(ls -d /Applications/Xcode_*.app 2>/dev/null | sort -t_ -k2 -V | tail -1)
          echo "Selected: $LATEST"
          sudo xcode-select -s "$LATEST/Contents/Developer"
          xcodebuild -version
          swift --version

      - name: Configure signing (Personal Team)
        if: inputs.signing_mode == 'personal'
        run: |
          cd apps/ios
          cat > LocalSigning.xcconfig << 'EOF'
          DEVELOPMENT_TEAM = ${{ secrets.APPLE_TEAM_ID }}
          CODE_SIGN_IDENTITY = Apple Development
          CODE_SIGN_STYLE = Automatic
          PRODUCT_BUNDLE_IDENTIFIER = ai.openclaw.app.lufe
          EOF

      - name: Generate Xcode project
        run: |
          cd apps/ios
          xcodegen generate
          ls -la OpenClaw.xcodeproj/

      - name: Build iOS app
        run: |
          cd apps/ios
          # Build with ad-hoc signing (produces binary, xtool will re-sign locally)
          xcodebuild \
            -project OpenClaw.xcodeproj \
            -scheme OpenClaw \
            -configuration Debug \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -derivedDataPath $GITHUB_WORKSPACE/build-output \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=YES \
            DEVELOPMENT_TEAM="" \
            COMPILER_INDEX_STORE_ENABLE=NO \
            clean build 2>&1 | tee /tmp/build.log | tail -100
          
          BUILD_EXIT=$?
          echo "Build exit code: $BUILD_EXIT"
          
          # Show where .app ended up
          echo "=== Searching for .app ==="
          find $GITHUB_WORKSPACE/build-output -name "*.app" -type d 2>/dev/null
          
          # Even if build "failed" on signing, the binary might exist
          if ! find $GITHUB_WORKSPACE/build-output -name "OpenClaw.app" -type d | head -1 | grep -q .; then
            echo "::warning::No .app found. Checking build products:"
            find $GITHUB_WORKSPACE/build-output/Build -type f -name "OpenClaw" 2>/dev/null | head -5
            echo "=== Last 50 lines of build log ==="
            tail -50 /tmp/build.log
          fi

      - name: Find and package IPA
        run: |
          echo "=== Searching for .app bundle ==="
          find $GITHUB_WORKSPACE/build-output -name "*.app" -type d 2>/dev/null
          echo "=== Searching in DerivedData ==="
          find ~/Library/Developer/Xcode/DerivedData -name "OpenClaw.app" -type d 2>/dev/null || true
          echo "=== Full build dir structure ==="
          find $GITHUB_WORKSPACE/build-output -maxdepth 5 -type d | head -40
          
          APP_PATH=$(find $GITHUB_WORKSPACE/build-output -name "OpenClaw.app" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "OpenClaw.app" -path "*/Release-iphoneos/*" -type d | head -1)
          fi
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "OpenClaw.app" -path "*/Debug-iphoneos/*" -type d | head -1)
          fi
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find . -name "OpenClaw.app" -type d | head -1)
          fi
          
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: OpenClaw.app not found anywhere"
            find . -name "*.app" -type d 2>/dev/null | head -20
            exit 1
          fi
          
          echo "Found app: $APP_PATH"
          mkdir -p /tmp/ipa/Payload
          cp -r "$APP_PATH" /tmp/ipa/Payload/
          cd /tmp/ipa
          zip -r OpenClaw-unsigned.ipa Payload/
          ls -lh OpenClaw-unsigned.ipa
          mv OpenClaw-unsigned.ipa $GITHUB_WORKSPACE/

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenClaw-iOS
          path: OpenClaw-unsigned.ipa
          retention-days: 30

      - name: Build summary
        run: |
          echo "## ðŸ¦ž OpenClaw iOS Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Config:** Debug (unsigned)" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform:** iOS" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact:** OpenClaw-unsigned.ipa" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the artifact and sign+install with \`xtool install\` on your Linux machine." >> $GITHUB_STEP_SUMMARY
